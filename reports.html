<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PRAVAH — Generate Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&family=Noto+Sans+Oriya:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg: #0b1220;
            --card: #0f172a;
            --muted: #94a3b8;
            --accent: #06d6a0;
            --accent-2: #3b82f6;
        }

        html,
        body {
            background-color: var(--bg);
            font-family: 'Inter', sans-serif;
            color: #cbd5e1;
            transition: font-family 0.3s ease;
        }

        body.lang-hi {
            font-family: 'Noto Sans Devanagari', sans-serif;
        }

        body.lang-or {
            font-family: 'Noto Sans Oriya', sans-serif;
        }

        .topbar {
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 0.75rem;
            padding: 2rem;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.01);
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-2);
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--muted);
        }

        .form-input,
        .form-select {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            padding: 0.75rem;
            color: white;
        }

        .form-select option {
            background-color: var(--bg);
            color: white;
        }

        .primary-btn {
            background-color: var(--accent-2);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .primary-btn:hover {
            background-color: #2563eb;
        }

        .lang-select {
            background-color: rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.4rem 2rem 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        .lang-select:focus {
            border-color: var(--accent-2);
        }

        .lang-select option {
            background-color: var(--bg);
            color: white;
        }
    </style>
</head>

<body>
    <div class="topbar px-6 py-3 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <a href="authority_dashboard.html" class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-md bg-gradient-to-br from-sky-600 to-indigo-600 flex items-center justify-center shadow">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M3 12h3l3-8 4 16 3-12 1 6h3" stroke="#fff" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </div>
                <div>
                    <div class="text-white font-semibold" data-i18n="brand">PRAVAH Traffic Control</div>
                    <div class="text-xs text-gray-400" data-i18n="sub_brand">Report Generation</div>
                </div>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative">
                <select id="lang-toggle" class="lang-select">
                    <option value="en">English</option>
                    <option value="hi">हिंदी</option>
                    <option value="or">ଓଡ଼ିଆ</option>
                </select>
            </div>
            <a href="menu.html" class="action-btn" data-i18n="btn_menu">Menu</a>
            <a href="authority_dashboard.html" class="action-btn" data-i18n="btn_back">Back to Dashboard</a>
        </div>
    </div>

    <main class="p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Create Report Section -->
            <div class="card">
                <h2 class="text-2xl font-bold text-white mb-6" data-i18n="title_create">Create a New Report</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="form-label" data-i18n="lbl_type">Report Type</label>
                        <select class="form-select" id="report-type-select">
                            <option data-i18n="opt_weekly">Weekly Performance Summary</option>
                            <option data-i18n="opt_daily">Daily Incident Log</option>
                            <option data-i18n="opt_cong">Congestion Hotspot Analysis</option>
                            <option data-i18n="opt_custom">Custom Report</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label" data-i18n="lbl_date">Date Range</label>
                        <div class="flex gap-2">
                            <input type="date" value="2025-09-20" class="form-input" id="start-date">
                            <input type="date" value="2025-09-27" class="form-input" id="end-date">
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="form-label" data-i18n="lbl_metrics">Metrics to Include</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                            <label class="flex items-center gap-2"><input type="checkbox"
                                    class="h-4 w-4 rounded metric-checkbox" value="avg_speed" checked> <span
                                    data-i18n="met_speed">Avg. Speed</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox"
                                    class="h-4 w-4 rounded metric-checkbox" value="vehicle_count" checked> <span
                                    data-i18n="met_count">Vehicle Count</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox"
                                    class="h-4 w-4 rounded metric-checkbox" value="violations"> <span
                                    data-i18n="met_viol">Violations</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox"
                                    class="h-4 w-4 rounded metric-checkbox" value="co2_levels" checked> <span
                                    data-i18n="met_co2">CO₂ Levels</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="form-label" data-i18n="lbl_format">Export Format</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2"><input type="radio" name="format" class="h-4 w-4"
                                    value="pdf" checked> PDF</label>
                            <label class="flex items-center gap-2"><input type="radio" name="format" class="h-4 w-4"
                                    value="csv"> CSV</label>
                            <label class="flex items-center gap-2"><input type="radio" name="format" class="h-4 w-4"
                                    value="excel"> Excel</label>
                        </div>
                    </div>
                </div>
                <div class="mt-8 border-t border-gray-700 pt-6 text-right">
                    <button class="primary-btn" onclick="generateReport()" data-i18n="btn_gen">Generate Report</button>
                </div>
            </div>

            <div class="card mt-8">
                <h3 class="text-xl font-semibold text-white mb-4" data-i18n="title_recent">Recently Generated Reports
                </h3>
                <table class="w-full text-sm text-left">
                    <thead class="border-b border-gray-700 text-gray-400">
                        <tr>
                            <th class="p-3" data-i18n="th_file">Filename</th>
                            <th class="p-3" data-i18n="th_date">Date Created</th>
                            <th class="p-3" data-i18n="th_fmt">Format</th>
                            <th class="p-3"></th>
                        </tr>
                    </thead>
                    <tbody id="reports-table-body">
                        <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                            <td class="p-3">Weekly_Report_2025-09-20.pdf</td>
                            <td class="p-3">20 Sep 2025</td>
                            <td class="p-3">PDF</td>
                            <td class="p-3 text-right"><a href="#" class="font-semibold text-blue-400"
                                    data-i18n="link_dl">Download</a></td>
                        </tr>
                        <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                            <td class="p-3">Incidents_2025-09-26.csv</td>
                            <td class="p-3">26 Sep 2025</td>
                            <td class="p-3">CSV</td>
                            <td class="p-3 text-right"><a href="#" class="font-semibold text-blue-400"
                                    data-i18n="link_dl">Download</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const { jsPDF } = window.jspdf;

        // Sample traffic data for reports
        function getReportData(metrics, startDate, endDate) {
            const allData = {
                avg_speed: [
                    { date: '2025-09-20', zone: 'Zone A - NH16', value: 45.2, unit: 'km/h' },
                    { date: '2025-09-21', zone: 'Zone A - NH16', value: 42.8, unit: 'km/h' },
                    { date: '2025-09-22', zone: 'Zone B - City Center', value: 28.5, unit: 'km/h' },
                    { date: '2025-09-23', zone: 'Zone B - City Center', value: 31.2, unit: 'km/h' },
                    { date: '2025-09-24', zone: 'Zone C - Ring Road', value: 55.6, unit: 'km/h' },
                    { date: '2025-09-25', zone: 'Zone C - Ring Road', value: 52.3, unit: 'km/h' },
                    { date: '2025-09-26', zone: 'Zone A - NH16', value: 48.1, unit: 'km/h' },
                    { date: '2025-09-27', zone: 'Zone B - City Center', value: 35.4, unit: 'km/h' }
                ],
                vehicle_count: [
                    { date: '2025-09-20', type: 'Cars', count: 12450, change: '+5.2%' },
                    { date: '2025-09-20', type: 'Bikes', count: 8320, change: '+3.1%' },
                    { date: '2025-09-20', type: 'Buses', count: 1250, change: '-2.4%' },
                    { date: '2025-09-20', type: 'Trucks', count: 2180, change: '+1.8%' },
                    { date: '2025-09-21', type: 'Cars', count: 11890, change: '+4.8%' },
                    { date: '2025-09-21', type: 'Bikes', count: 7950, change: '+2.9%' },
                    { date: '2025-09-21', type: 'Buses', count: 1180, change: '-1.2%' },
                    { date: '2025-09-21', type: 'Trucks', count: 2050, change: '+2.1%' }
                ],
                violations: [
                    { date: '2025-09-20', type: 'Signal Violation', location: 'Junction A', count: 12 },
                    { date: '2025-09-20', type: 'Speeding', location: 'NH16 Km 45', count: 28 },
                    { date: '2025-09-21', type: 'Wrong Lane', location: 'Ring Road', count: 8 },
                    { date: '2025-09-22', type: 'Signal Violation', location: 'Junction B', count: 15 },
                    { date: '2025-09-23', type: 'Speeding', location: 'NH16 Km 52', count: 22 },
                    { date: '2025-09-24', type: 'No Helmet', location: 'City Center', count: 45 },
                    { date: '2025-09-25', type: 'Signal Violation', location: 'Junction C', count: 9 }
                ],
                co2_levels: [
                    { date: '2025-09-20', zone: 'Zone A', level: 285, status: 'Good' },
                    { date: '2025-09-21', zone: 'Zone A', level: 298, status: 'Good' },
                    { date: '2025-09-22', zone: 'Zone B', level: 342, status: 'Moderate' },
                    { date: '2025-09-23', zone: 'Zone B', level: 325, status: 'Moderate' },
                    { date: '2025-09-24', zone: 'Zone C', level: 412, status: 'High' },
                    { date: '2025-09-25', zone: 'Zone C', level: 385, status: 'Moderate' },
                    { date: '2025-09-26', zone: 'Zone A', level: 275, status: 'Good' }
                ]
            };

            const result = {};
            metrics.forEach(metric => {
                if (allData[metric]) {
                    result[metric] = allData[metric];
                }
            });
            return result;
        }

        // Generate Report based on selected format
        function generateReport() {
            const reportType = document.getElementById('report-type-select');
            const reportTypeName = reportType.options[reportType.selectedIndex].text;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const format = document.querySelector('input[name="format"]:checked').value;
            const metrics = Array.from(document.querySelectorAll('.metric-checkbox:checked')).map(cb => cb.value);

            if (metrics.length === 0) {
                alert('Please select at least one metric to include in the report.');
                return;
            }

            let filename;

            if (format === 'pdf') {
                filename = generatePDF(reportTypeName, startDate, endDate, metrics);
            } else if (format === 'csv') {
                filename = generateCSV(reportTypeName, startDate, endDate, metrics);
            } else if (format === 'excel') {
                filename = generateExcel(reportTypeName, startDate, endDate, metrics);
            }

            addReportToTable(filename, format.toUpperCase());
        }

        // Generate PDF Report
        function generatePDF(reportTypeName, startDate, endDate, metrics) {
            const doc = new jsPDF();
            const data = getReportData(metrics, startDate, endDate);

            // Header
            doc.setFontSize(18);
            doc.setTextColor(59, 130, 246);
            doc.text('PRAVAH Traffic Report', 20, 20);

            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(reportTypeName, 20, 30);

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 20, 38);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 44);

            doc.setDrawColor(59, 130, 246);
            doc.line(20, 48, 190, 48);

            let y = 58;

            // Add data for each metric
            const metricLabels = {
                avg_speed: 'Average Speed Data',
                vehicle_count: 'Vehicle Count Data',
                violations: 'Traffic Violations',
                co2_levels: 'CO₂ Emission Levels'
            };

            metrics.forEach(metric => {
                if (data[metric] && y < 250) {
                    doc.setFontSize(12);
                    doc.setTextColor(0);
                    doc.text(metricLabels[metric], 20, y);
                    y += 8;

                    doc.setFontSize(9);
                    doc.setTextColor(60);

                    data[metric].slice(0, 4).forEach(row => {
                        const rowText = Object.values(row).join(' | ');
                        doc.text(rowText, 20, y);
                        y += 5;
                    });
                    y += 8;
                }
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('PRAVAH Traffic Control System', 20, 285);
            doc.text('Page 1 of 1', 180, 285);

            const filename = `PRAVAH_Report_${startDate}_to_${endDate}.pdf`;
            doc.save(filename);
            return filename;
        }

        // Generate CSV Report
        function generateCSV(reportTypeName, startDate, endDate, metrics) {
            const data = getReportData(metrics, startDate, endDate);
            let csvContent = '';

            // Header info
            csvContent += `PRAVAH Traffic Report\n`;
            csvContent += `Report Type,${reportTypeName}\n`;
            csvContent += `Date Range,${startDate} to ${endDate}\n`;
            csvContent += `Generated,${new Date().toLocaleString()}\n\n`;

            const metricLabels = {
                avg_speed: 'Average Speed Data',
                vehicle_count: 'Vehicle Count Data',
                violations: 'Traffic Violations',
                co2_levels: 'CO2 Emission Levels'
            };

            metrics.forEach(metric => {
                if (data[metric] && data[metric].length > 0) {
                    csvContent += `\n${metricLabels[metric]}\n`;

                    // Get headers from first row
                    const headers = Object.keys(data[metric][0]);
                    csvContent += headers.join(',') + '\n';

                    // Add data rows
                    data[metric].forEach(row => {
                        const values = Object.values(row).map(val => {
                            // Escape commas and quotes in values
                            if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
                                return `"${val.replace(/"/g, '""')}"`;
                            }
                            return val;
                        });
                        csvContent += values.join(',') + '\n';
                    });
                }
            });

            // Create and download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const filename = `PRAVAH_Report_${startDate}_to_${endDate}.csv`;

            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);

            return filename;
        }

        // Generate Excel Report
        function generateExcel(reportTypeName, startDate, endDate, metrics) {
            const data = getReportData(metrics, startDate, endDate);
            const workbook = XLSX.utils.book_new();

            // Create Summary sheet
            const summaryData = [
                ['PRAVAH Traffic Report'],
                [''],
                ['Report Type', reportTypeName],
                ['Date Range', `${startDate} to ${endDate}`],
                ['Generated', new Date().toLocaleString()],
                [''],
                ['Metrics Included:'],
                ...metrics.map(m => ['', m.replace('_', ' ').toUpperCase()])
            ];
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');

            const metricLabels = {
                avg_speed: 'Average Speed',
                vehicle_count: 'Vehicle Count',
                violations: 'Violations',
                co2_levels: 'CO2 Levels'
            };

            // Create a sheet for each metric
            metrics.forEach(metric => {
                if (data[metric] && data[metric].length > 0) {
                    const sheet = XLSX.utils.json_to_sheet(data[metric]);
                    XLSX.utils.book_append_sheet(workbook, sheet, metricLabels[metric]);
                }
            });

            // Generate and download Excel file
            const filename = `PRAVAH_Report_${startDate}_to_${endDate}.xlsx`;
            XLSX.writeFile(workbook, filename);

            return filename;
        }

        function addReportToTable(filename, format) {
            const tbody = document.getElementById('reports-table-body');
            const today = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-800 hover:bg-gray-800/50';
            row.innerHTML = `
                <td class="p-3">${filename}</td>
                <td class="p-3">${today}</td>
                <td class="p-3">${format}</td>
                <td class="p-3 text-right"><a href="#" class="font-semibold text-blue-400">Download</a></td>
            `;
            tbody.insertBefore(row, tbody.firstChild);
        }

        // Translations
        const translations = {
            en: {
                brand: "PRAVAH Traffic Control",
                sub_brand: "Report Generation",
                btn_menu: "Menu",
                btn_back: "Back to Dashboard",
                title_create: "Create a New Report",
                lbl_type: "Report Type",
                opt_weekly: "Weekly Performance Summary",
                opt_daily: "Daily Incident Log",
                opt_cong: "Congestion Hotspot Analysis",
                opt_custom: "Custom Report",
                lbl_date: "Date Range",
                lbl_metrics: "Metrics to Include",
                met_speed: "Avg. Speed",
                met_count: "Vehicle Count",
                met_viol: "Violations",
                met_co2: "CO₂ Levels",
                lbl_format: "Export Format",
                btn_gen: "Generate Report",
                title_recent: "Recently Generated Reports",
                th_file: "Filename",
                th_date: "Date Created",
                th_fmt: "Format",
                link_dl: "Download"
            },
            hi: {
                brand: "प्रवाह यातायात नियंत्रण",
                sub_brand: "रिपोर्ट जनरेशन",
                btn_menu: "मेनू",
                btn_back: "डैशबोर्ड पर वापस जाएं",
                title_create: "नई रिपोर्ट बनाएं",
                lbl_type: "रिपोर्ट का प्रकार",
                opt_weekly: "साप्ताहिक प्रदर्शन सारांश",
                opt_daily: "दैनिक घटना लॉग",
                opt_cong: "भीड़भाड़ हॉटस्पॉट विश्लेषण",
                opt_custom: "कस्टम रिपोर्ट",
                lbl_date: "तिथि सीमा",
                lbl_metrics: "शामिल करने के लिए मेट्रिक्स",
                met_speed: "औसत गति",
                met_count: "वाहन संख्या",
                met_viol: "उल्लंघन",
                met_co2: "CO₂ स्तर",
                lbl_format: "निर्यात प्रारूप",
                btn_gen: "रिपोर्ट तैयार करें",
                title_recent: "हाल ही में तैयार की गई रिपोर्ट",
                th_file: "फ़ाइल का नाम",
                th_date: "बनाने की तिथि",
                th_fmt: "प्रारूप",
                link_dl: "डाउनलोड"
            },
            or: {
                brand: "ପ୍ରବାହ ଟ୍ରାଫିକ୍ ନିୟନ୍ତ୍ରଣ",
                sub_brand: "ରିପୋର୍ଟ ଜେନେରେସନ୍",
                btn_menu: "ମେନୁ",
                btn_back: "ଡ୍ୟାସବୋର୍ଡକୁ ଫେରନ୍ତୁ",
                title_create: "ନୂତନ ରିପୋର୍ଟ ସୃଷ୍ଟି କରନ୍ତୁ",
                lbl_type: "ରିପୋର୍ଟ ପ୍ରକାର",
                opt_weekly: "ସାପ୍ତାହିକ କାର୍ଯ୍ୟଦକ୍ଷତା ସାରାଂଶ",
                opt_daily: "ଦୈନିକ ଘଟଣା ଲଗ୍",
                opt_cong: "ଭିଡ଼ ହଟସ୍ପଟ୍ ବିଶ୍ଳେଷଣ",
                opt_custom: "କଷ୍ଟମ୍ ରିପୋର୍ଟ",
                lbl_date: "ତାରିଖ ସୀମା",
                lbl_metrics: "ଅନ୍ତର୍ଭୁକ୍ତ କରିବାକୁ ମେଟ୍ରିକ୍ସ",
                met_speed: "ହାରାହାରି ଗତି",
                met_count: "ଗାଡି ସଂଖ୍ୟା",
                met_viol: "ନିୟମ ଉଲ୍ଲଂଘନ",
                met_co2: "CO₂ ସ୍ତର",
                lbl_format: "ରପ୍ତାନି ଫର୍ମାଟ୍",
                btn_gen: "ରିପୋର୍ଟ ତିଆରି କରନ୍ତୁ",
                title_recent: "ସମ୍ପ୍ରତି ପ୍ରସ୍ତୁତ ରିପୋର୍ଟଗୁଡିକ",
                th_file: "ଫାଇଲ୍ ନାମ",
                th_date: "ତିଆରି ତାରିଖ",
                th_fmt: "ଫର୍ମାଟ୍",
                link_dl: "ଡାଉନଲୋଡ୍"
            }
        };

        const langToggle = document.getElementById('lang-toggle');

        function updateLanguage(lang) {
            document.body.classList.remove('lang-hi', 'lang-or');
            if (lang === 'hi') document.body.classList.add('lang-hi');
            if (lang === 'or') document.body.classList.add('lang-or');

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
        }

        langToggle.addEventListener('change', (e) => {
            localStorage.setItem('language', e.target.value);
            updateLanguage(e.target.value);
        });

        const savedLang = localStorage.getItem('language') || 'en';
        langToggle.value = savedLang;
        updateLanguage(savedLang);
    </script>
</body>

</html>